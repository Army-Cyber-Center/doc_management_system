import Tesseract from 'tesseract.js';

class OCRService {

  async processImage(imageFile) {
    try {
      console.log('ðŸ¤– à¹€à¸£à¸´à¹ˆà¸¡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ OCR...');

      const imageUrl = URL.createObjectURL(imageFile);

      const result = await Tesseract.recognize(
        imageUrl,
        'tha+eng',
        {
          logger: (m) => {
            if (m.status === 'recognizing text') {
              console.log(`ðŸ“Š à¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²: ${Math.round(m.progress * 100)}%`);
            }
          }
        }
      );

      const text = result.data.text || "";
      console.log('ðŸ“„ Raw OCR Text:', text);

      URL.revokeObjectURL(imageUrl);

      return this.extractStructuredData(text);

    } catch (err) {
      console.error("âŒ OCR Error:", err);
      throw err;
    }
  }

  //-------------------------------------------------------------------
  // ðŸ§  MAIN STRUCTURING
  //-------------------------------------------------------------------

  extractStructuredData(text) {
    const cleaned = this.cleanText(text);

    return {
      department: this.extractDepartment(cleaned) || "",
      documentNo: this.extractDocumentNumber(cleaned) || "",
      date: this.extractDate(cleaned) || "",
      subject: this.extractSubject(cleaned) || "",
      priority: this.analyzePriority(cleaned) || "à¸›à¸à¸•à¸´",
      keywords: this.extractKeywords(cleaned)
    };
  }

  

  //-------------------------------------------------------------------
  // ðŸ§¼ CLEAN TEXT
  //-------------------------------------------------------------------

  cleanText(text) {
    return text
      .replace(/\r/g, "")
      .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9/\- .:\n]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  //-------------------------------------------------------------------
  // ðŸ¢ à¸ªà¹ˆà¸§à¸™à¸£à¸²à¸Šà¸à¸²à¸£
  // à¸£à¸­à¸‡à¸£à¸±à¸šà¸£à¸¹à¸›à¹à¸šà¸šà¸£à¸²à¸Šà¸à¸²à¸£ à¹€à¸Šà¹ˆà¸™:
  // à¸ªà¹ˆà¸§à¸™à¸£à¸²à¸Šà¸à¸²à¸£ à¸à¸­à¸‡à¸„à¸¥à¸±à¸‡ à¸à¸£à¸¡à¸à¸²à¸£à¸›à¸à¸„à¸£à¸­à¸‡
  // à¸ˆà¸²à¸ à¸à¸­à¸‡à¸à¸³à¸¥à¸±à¸‡ ...
  //-------------------------------------------------------------------

  extractDepartment(text) {
    const patterns = [
      /à¸ªà¹ˆà¸§à¸™à¸£à¸²à¸Šà¸à¸²à¸£[:\s]*([^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|à¹€à¸£à¸µà¸¢à¸™|à¹‚à¸—à¸£|$)/,
      /à¸ˆà¸²à¸[:\s]*([^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|à¹€à¸£à¸µà¸¢à¸™|$)/,
      /(à¸à¸£à¸¡[^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|$)/,
      /(à¸à¸­à¸‡[^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|$)/,
      /(à¸ªà¸³à¸™à¸±à¸[^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|$)/,
      /(à¸à¹ˆà¸²à¸¢[^\n]+?)(?=à¸—à¸µà¹ˆ|à¸§à¸±à¸™à¸—à¸µà¹ˆ|à¹€à¸£à¸·à¹ˆà¸­à¸‡|$)/,
    ];

    for (const p of patterns) {
      const m = text.match(p);
      if (m) return m[1].trim();
    }

    // fallback à¸•à¸£à¸§à¸ˆà¸šà¸£à¸£à¸—à¸±à¸”à¹à¸£à¸à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸³à¸™à¸µà¹‰
    const line = text.split("\n").find(l =>
      /(à¸à¸£à¸¡|à¸à¸­à¸‡|à¸ªà¸³à¸™à¸±à¸|à¸à¹ˆà¸²à¸¢)/.test(l)
    );
    return line ? line.trim() : "";
  }

  //-------------------------------------------------------------------
  // ï¿½ï¿½ à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸«à¸™à¸±à¸‡à¸ªà¸·à¸­ (à¸—à¸µà¹ˆ...)
  // à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š:
  // à¸—à¸µà¹ˆ à¸¨à¸˜ 0201/2568
  // à¸—à¸µà¹ˆ à¸à¸„ 123/2567
  // à¹€à¸¥à¸‚à¸—à¸µà¹ˆ 112/2568
  //-------------------------------------------------------------------

  extractDocumentNumber(text) {
    const patterns = [
      /à¸—à¸µà¹ˆ[:\s]*([à¸-à¸®A-Za-z. ]*\d{1,5}\/25\d{2})/,
      /à¹€à¸¥à¸‚à¸—à¸µà¹ˆ[:\s]*([^\s]+\/25\d{2})/,
      /\b(\d{2,5}\/25\d{2})\b/
    ];

    for (const p of patterns) {
      const m = text.match(p);
      if (m) return this.convertThaiNumberToArabic(m[1].trim());
    }

    return "";
  }

  //-------------------------------------------------------------------
  // ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ
  // à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¹€à¸•à¹‡à¸¡/à¸¢à¹ˆà¸­ à¹€à¸Šà¹ˆà¸™:
  // à¸§à¸±à¸™à¸—à¸µà¹ˆ 19 à¸•à¸¸à¸¥à¸²à¸„à¸¡ 2568
  // à¸§à¸±à¸™à¸—à¸µà¹ˆ 19/10/2568
  // 19 à¸•.à¸„. 2568
  //-------------------------------------------------------------------

  extractDate(text) {
    const MONTHS =
      "à¸¡à¸à¸£à¸²à¸„à¸¡|à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ|à¸¡à¸µà¸™à¸²à¸„à¸¡|à¹€à¸¡à¸©à¸²à¸¢à¸™|à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡|à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™|" +
      "à¸à¸£à¸à¸Žà¸²à¸„à¸¡|à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡|à¸à¸±à¸™à¸¢à¸²à¸¢à¸™|à¸•à¸¸à¸¥à¸²à¸„à¸¡|à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™|à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡|" +
      "à¸¡.à¸„.|à¸.à¸ž.|à¸¡à¸µ.à¸„.|à¹€à¸¡.à¸¢.|à¸ž.à¸„.|à¸¡à¸´.à¸¢.|à¸.à¸„.|à¸ª.à¸„.|à¸.à¸¢.|à¸•.à¸„.|à¸ž.à¸¢.|à¸˜.à¸„.";

    const patterns = [
      new RegExp(`à¸§à¸±à¸™à¸—à¸µà¹ˆ[:\\s]*([à¹-à¹™0-9]{1,2} (${MONTHS}) [à¹-à¹™0-9]{4})`),
      /à¸§à¸±à¸™à¸—à¸µà¹ˆ[:\s]*([à¹-à¹™0-9]{1,2}\/[à¹-à¹™0-9]{1,2}\/[à¹-à¹™0-9]{4})/,
      new RegExp(`([à¹-à¹™0-9]{1,2} (${MONTHS}) [à¹-à¹™0-9]{4})`),
    ];

    for (const p of patterns) {
      const m = text.match(p);
      if (m) return this.convertThaiNumberToArabic(m[1]);
    }

    return "";
  }

  //-------------------------------------------------------------------
  // ðŸ“ à¹€à¸£à¸·à¹ˆà¸­à¸‡
  // à¸£à¸­à¸‡à¸£à¸±à¸š:
  // à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¸‚à¸­à¸„à¸§à¸²à¸¡à¸­à¸™à¸¸à¹€à¸„à¸£à¸²à¸°à¸«à¹Œâ€¦
  // à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¸£à¸²à¸¢à¸‡à¸²à¸™à¸œà¸¥à¸à¸²à¸£à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸‡à¸²à¸™â€¦
  //-------------------------------------------------------------------

  extractSubject(text) {
    const patterns = [
      /à¹€à¸£à¸·à¹ˆà¸­à¸‡[:\s]*([^\n]+?)(?=à¹€à¸£à¸µà¸¢à¸™|à¸”à¹‰à¸§à¸¢|à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²à¸”à¹‰à¸§à¸¢|$)/,
      /à¹€à¸£à¸·à¹ˆà¸­à¸‡[:\s]*([\s\S]{5,200})/
    ];

    for (const p of patterns) {
      const m = text.match(p);
      if (m) return m[1].trim().replace(/\s+/g, " ");
    }

    return "";
  }

  //-------------------------------------------------------------------
  // â±ï¸ à¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸
  //-------------------------------------------------------------------

  analyzePriority(text) {
    if (/à¸”à¹ˆà¸§à¸™à¸—à¸µà¹ˆà¸ªà¸¸à¸”/.test(text)) return "à¸”à¹ˆà¸§à¸™à¸—à¸µà¹ˆà¸ªà¸¸à¸”";
    if (/à¸”à¹ˆà¸§à¸™à¸¡à¸²à¸/.test(text)) return "à¸”à¹ˆà¸§à¸™à¸¡à¸²à¸";
    if (/à¸”à¹ˆà¸§à¸™/.test(text)) return "à¸”à¹ˆà¸§à¸™";
    return "à¸›à¸à¸•à¸´";
  }

  //-------------------------------------------------------------------
  // ðŸ”‘ à¸„à¸³à¸ªà¸³à¸„à¸±à¸ (Top 6)
  //-------------------------------------------------------------------

  extractKeywords(text) {
    const stopWords = ["à¹à¸¥à¸°", "à¸«à¸£à¸·à¸­", "à¸§à¹ˆà¸²", "à¹ƒà¸™", "à¹€à¸›à¹‡à¸™", "à¸—à¸µà¹ˆ", "à¸‹à¸¶à¹ˆà¸‡", "à¸•à¸²à¸¡"];
    const words = (text.match(/[à¸-à¸®]{3,}/g) || [])
      .filter(w => !stopWords.includes(w));

    const freq = {};
    words.forEach(w => freq[w] = (freq[w] || 0) + 1);

    return Object.entries(freq)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 6)
      .map(([w]) => w);
  }

  //-------------------------------------------------------------------
  // ðŸ”¢ à¹à¸›à¸¥à¸‡à¹€à¸¥à¸‚à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¹€à¸¥à¸‚à¸­à¸²à¸£à¸šà¸´à¸
  //-------------------------------------------------------------------

  convertThaiNumberToArabic(text) {
    const map = { 'à¹': 0,'à¹‘': 1,'à¹’': 2,'à¹“': 3,'à¹”': 4,'à¹•': 5,'à¹–': 6,'à¹—': 7,'à¹˜': 8,'à¹™': 9 };
    return text.replace(/[à¹-à¹™]/g, m => map[m]);
  }

}

const ocrService = new OCRService();
export default ocrService;

